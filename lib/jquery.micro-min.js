/*


 jQuery Micro version 0.1.1

 Pico/Nano like editor for jquery

 http://micro.jcubic.pl

 Licensed under GNU GPL Version 3 license
 Copyright (c) 2013 Jakub Jankiewicz <http://jcubic.pl>

 Contain:
 sprintf.js: Copyright (c) 2007-2013 Alexandru Marasteanu <hello at alexei dot ro>
 licensed under 3 clause BSD license

 Date: Sun, 09 Feb 2014 15:45:52 +0000
*/
(function(e){function l(i){return Object.prototype.toString.call(i).slice(8,-1).toLowerCase()}var k=function(){k.cache.hasOwnProperty(arguments[0])||(k.cache[arguments[0]]=k.parse(arguments[0]));return k.format.call(null,k.cache[arguments[0]],arguments)};k.format=function(i,c){var d=1,a=i.length,b="",g=[],f,j,h,m;for(f=0;f<a;f++){b=l(i[f]);if(b==="string")g.push(i[f]);else if(b==="array"){h=i[f];if(h[2]){b=c[d];for(j=0;j<h[2].length;j++){if(!b.hasOwnProperty(h[2][j]))throw k('[sprintf] property "%s" does not exist',
h[2][j]);b=b[h[2][j]]}}else b=h[1]?c[h[1]]:c[d++];if(/[^s]/.test(h[8])&&l(b)!="number")throw k("[sprintf] expecting number but found %s",l(b));switch(h[8]){case "b":b=b.toString(2);break;case "c":b=String.fromCharCode(b);break;case "d":b=parseInt(b,10);break;case "e":b=h[7]?b.toExponential(h[7]):b.toExponential();break;case "f":b=h[7]?parseFloat(b).toFixed(h[7]):parseFloat(b);break;case "o":b=b.toString(8);break;case "s":b=(b=String(b))&&h[7]?b.substring(0,h[7]):b;break;case "u":b>>>=0;break;case "x":b=
b.toString(16);break;case "X":b=b.toString(16).toUpperCase()}b=/[def]/.test(h[8])&&h[3]&&b>=0?"+"+b:b;j=h[4]?h[4]=="0"?"0":h[4].charAt(1):" ";m=h[6]-String(b).length;if(h[6]){for(var n=[];m>0;n[--m]=j);j=n.join("")}else j="";g.push(h[5]?b+j:j+b)}}return g.join("")};k.cache={};k.parse=function(i){for(var c=[],d=[],a=0;i;){if((c=/^[^\x25]+/.exec(i))!==null)d.push(c[0]);else if((c=/^\x25{2}/.exec(i))!==null)d.push("%");else if((c=/^\x25(?:([1-9]\d*)\$|\(([^\)]+)\))?(\+)?(0|'[^$])?(-)?(\d+)?(?:\.(\d+))?([b-fosuxX])/.exec(i))!==
null){if(c[2]){a|=1;var b=[],g=c[2],f=[];if((f=/^([a-z_][a-z_\d]*)/i.exec(g))!==null)for(b.push(f[1]);(g=g.substring(f[0].length))!=="";)if((f=/^\.([a-z_][a-z_\d]*)/i.exec(g))!==null)b.push(f[1]);else if((f=/^\[(\d+)\]/.exec(g))!==null)b.push(f[1]);else throw"[sprintf] huh?";else throw"[sprintf] huh?";c[2]=b}else a|=2;if(a===3)throw"[sprintf] mixing positional and named placeholders is not (yet) supported";d.push(c)}else throw"[sprintf] huh?";i=i.substring(c[0].length)}return d};e.sprintf=k;e.vsprintf=
function(i,c,d){d=c.slice(0);d.splice(0,0,i);return k.apply(null,d)}})(typeof exports!="undefined"?exports:window);
(function(e){function l(c,d){for(var a="",b=d;b--;)a+=c;return a}function k(c,d){this._root=e(c);this._letter=this._calculate_letter_size();this._root.addClass("micro");this._root.css({width:d.width,height:d.height});this._settings=d;this._title=e("<div/>").addClass("title").appendTo(this._root);this._set_file_name("");this._spacer=e("<div/>").addClass("spacer").appendTo(this._root);this._input=e("<input/>").appendTo(this._spacer);this._clipboard=e("<textarea/>").addClass("clipboard").appendTo(this._spacer);
this._table=e("<div/>").addClass("matrix");this.refresh();this._pointer={x:0,y:0};this._table.appendTo(this._root);this._footer=e("<div/>").addClass("footer").appendTo(this._root);this._footer_line_1=e("<div/>").addClass("line1").appendTo(this._footer);this._footer_line_2=e("<div/>").addClass("line2").appendTo(this._footer);this._message=e("<div/>").addClass("message").append("<span/>").appendTo(this._root).find("span");this._lines=[""];this._cursor_offset=this._page=this._offset=0;var a=this;this._print_footer_keys(i);
this._input.bind("keydown.micro",function(b){if(a._focus){var g=a._lines[a._pointer.y],f=a._tabs_count(g);if(b.which===37){a._pointer.x>0&&a._set_pointer(a._pointer.x-1,a._pointer.y);b.preventDefault()}else if(b.which===39){a._pointer.x<g.length&&a._set_pointer(a._pointer.x+1,a._pointer.y);b.preventDefault()}else if(b.which===38){a._pointer.y>0&&a._set_pointer(a._pointer.x,a._pointer.y-1);b.preventDefault()}else if(b.which===40){a._pointer.y<a._lines.length-1&&a._set_pointer(a._pointer.x,a._pointer.y+
1);b.preventDefault()}else if(b.which===35){a._set_pointer(g.length,a._pointer.y);b.preventDefault()}else if(b.which===36){a._set_pointer(0,a._pointer.y);b.preventDefault()}else if(b.which===8)if(a._pointer.x===0){if(a._pointer.y>0){f=a._lines[a._pointer.y-1].length;a._lines[a._pointer.y-1]+=a._lines[a._pointer.y];a._lines=a._lines.slice(0,a._pointer.y).concat(a._lines.slice(a._pointer.y+1));a._set_pointer(f,a._pointer.y-1);a._view(a._offset)}}else if(a._pointer.x>0){f=a._pointer.x>g.length?g.length-
f:a._pointer.x;a._lines[a._pointer.y]=g.slice(0,f-1)+g.slice(f,g.length);a._draw_cursor_line();a._set_pointer(f-1,a._pointer.y)}else{f=a._lines[a._pointer.y-1];a._lines=a._lines.slice(0,a._pointer.y-1).concat(a._lines.slice(a._pointer.y));a._lines[a._pointer.y-1]=f+g;a._pointer.y--;a._pointer.x=f.length;a._set_pointer(a._pointer.x,a._pointer.y);a._view(a._offset)}else if(b.which===46)if(g.length===a._pointer.x){if(a._lines.length>a._pointer.y+1){a._lines[a._pointer.y]+=a._lines[a._pointer.y+1];a._lines=
a._lines.slice(0,a._pointer.y+1).concat(a._lines.slice(a._pointer.y+2));a._view(a._offset)}}else{a._lines[a._pointer.y]=g.slice(0,a._pointer.x)+g.slice(a._pointer.x+1,g.length);a._draw_cursor_line()}else if(b.which===13){f=g.slice(a._pointer.x);a._lines[a._pointer.y]=g.slice(0,a._pointer.x);a._lines=a._lines.slice(0,a._pointer.y+1).concat([f]).concat(a._lines.slice(a._pointer.y+1));a._set_pointer(0,a._pointer.y+1);a._view(a._offset)}if(b.ctrlKey)if(b.which===86){a._clipboard.val("").focus();setTimeout(function(){a.insert(a._clipboard.val());
a._clipboard.val("");a._input.focus()},100)}else if(b.which===79){typeof a._settings.save==="function"?a._settings.save.apply(a._root):a.message("[ "+e.micro.strings.no_save+" ]");b.preventDefault()}a._settings.cursorPosition||(b.ctrlKey&&b.which===67?a._print_cur_position():a.message(""))}}).bind("keypress.micro",function(b){if(!b.ctrlKey){var g=String.fromCharCode(b.which);a.insert(g)}b.preventDefault()});e(document).bind("click.micro",function(b){b=e(b.target).parents(".micro");b.length?b.data("micro").focus():
a.blur()});this._table.on("click","span",function(){var b=e(this),g=a._offset+b.parents(".line").index(),f=b.index();b=a._lines[a._pointer.y];var j=a._get_cursor_offset();if(j>0&&a._pointer.y==g){var h=a._tabs_count(b);f=j+f-1-h;if(f>b.length-h)f=b.length-h;a._set_pointer(f,g)}else{a._cursor_offset>0&&a._pointer.y!=g&&a._draw_line(a._pointer.y-a._offset,b);if(a._lines[g]){if(f>a._lines[g].length)f=a._lines[g].length;a._set_pointer(f,g)}}});d.enabled?this.focus():this.blur()}var i=1;k.prototype={_print_footer_line:function(c,
d){var a=this,b=Math.round(this._cols/c.length)-3;e.each(c,function(g,f){e("<span>"+f[0]+"</span>").addClass("key").appendTo(d);var j;j=f[1].length>b?f[1].substring(0,b):f[1].length<b?f[1]+l(" ",b-f[1].length):f[1];e("<span>"+a._encode(" "+j)+"</span>").appendTo(d)})},_print_footer_keys:function(c){var d,a;switch(c){case i:d=[["^G",e.micro.strings.get_help],["^O",e.micro.strings.write_out],["^R",e.micro.strings.read_file],["^Y",e.micro.strings.prev_page],["^K",e.micro.strings.cut_text],["^C",e.micro.strings.cur_pos]];
a=[["^X",e.micro.strings.exit],["^J",e.micro.strings.justify],["^W",e.micro.strings.where_is],["^V",e.micro.strings.next_page],["^U",e.micro.strings.uncut_text],["^T",e.micro.strings.to_spell]]}d&&this._print_footer_line(d,this._footer_line_1);a&&this._print_footer_line(a,this._footer_line_2)},insert:function(c){var d=c.split("\n"),a=this._lines[this._pointer.y],b=a.slice(this._pointer.x);this._lines[this._pointer.y]=a.slice(0,this._pointer.x)+d[0];if(d.length==1){this._lines[this._pointer.y]+=b;
this._set_pointer(this._pointer.x+c.length,this._pointer.y);this._draw_cursor_line()}else{d[0]=a.slice(0,this._pointer.x)+d[0];c=d[d.length-1].length;d[d.length-1]+=b;this._lines=this._lines.slice(0,this._pointer.y-1).concat(d).concat(this._lines.slice(this._pointer.y+1));this._set_pointer(c,this._pointer.y+d.length-2);this._view(this._offset)}},focus:function(){this._focus=true;this._table.find(".inactive").removeClass("inactive").css({width:"",height:""});this._input.focus()},blur:function(){this._focus=
false;this._table.find(".cursor").addClass("inactive").css({width:this._letter.width-2,height:this._letter.height-2})},cols:function(){return this._cols},rows:function(){return this._rows},destroy:function(){this._root.removeData("micro").removeClass("micro");this._table.remove();this._input.unbind(".micro");this._spacer.remove();this._footer.remove();this._message.remove();e(document).unbind(".micro")},refresh:function(){this._letter=this._calculate_letter_size();this._rows=Math.floor(this._root.height()/
this._letter.height)-4;this._cols=Math.floor(this._root.width()/this._letter.width);this._matrix=[];this._table.empty();for(var c=0;c<this._rows;++c){var d=e("<div/>").addClass("line").appendTo(this._table);this._matrix[c]=[];for(var a=0;a<this._cols;++a){var b=e("<span>&nbsp;</span>").appendTo(d);this._matrix[c][a]=b}}return this},set:function(c){this._lines=c.split("\n");this._set_pointer(0,0);this._view(0)},get:function(){return this._lines.join("\n")},_print_cur_position:function(){var c=0,d=
0,a=this;e.each(this._lines,function(g,f){if(g<a._pointer.y)c+=f.length;else if(g==a._pointer.y)c+=a._pointer.x;d+=f.length});var b=this._lines[this._pointer.y];this.message("[ "+sprintf(e.micro.strings.chr,this._pointer.y+1,this._lines.length,(this._pointer.y+1)*100/this._lines.length,this._pointer.x+1,b.length+1,(this._pointer.x+1)*100/(b.length+1),c,d,c*100/d)+" ]")},_set_pointer:function(c,d){if(d>=this._lines.length)throw Error("[micro::_set_pointer]: Y out of band ("+d+"/"+this._lines.length+
")");this._table.find(".cursor").removeClass("cursor");var a=this._lines[d],b=this._lines[this._pointer.y],g=this._tabs_count(a);b=this._tabs_count(b);d!=this._pointer.y&&this._pointer.x>=this._cols-b-1&&this._draw_line(this._pointer.y-this._offset,this._lines[this._pointer.y]);if(c>a.length)c=a.length;else if(c<0)c=0;b=Math.floor(this._rows/2);a=this._offset+this._rows-b;if(d-this._offset>=this._rows){b=d-a;if(this._offset!==a){this._pointer.x=c;this._pointer.y=d;this._view(a)}}else if(d-this._offset<
0){a=this._offset-this._rows+b;this._pointer.x=c;this._pointer.y=d;this._view(a);b=d-a}else b=d-a+b+1;if(c+g>=this._cols-1){this._pointer.x=c;this._pointer.y=d;this._draw_cursor_line()}else{this._pointer.x+g>=this._cols-1&&this._draw_line(this._pointer.y-this._offset,this._lines[this._pointer.y]);c>this._lines[d].length?this._matrix[b][this._lines[d].length].addClass("cursor"):this._matrix[b][c].addClass("cursor")}this._pointer.x=c;this._pointer.y=d;this._settings.cursorPosition&&this._print_cur_position()},
_encode:function(c){return c.replace(/ /g,"&nbsp;").replace(/\t/g,l("&nbsp;",this._settings.tabStop))},_draw_line:function(c,d){var a=d.length>this._cols?this._cols:d.length,b;for(b=0;b<a;++b)this._matrix[c][b].html(this._encode(d[b]));a=this._tabs_count(d);if(d.length+a>this._cols){this._matrix[c][this._cols-1-a].html("$");if(a>0)for(b=this._cols-a;b<this._cols;++b)this._matrix[c][b].html("&nbsp")}else for(b=d.length;b<this._cols;++b)this._matrix[c][b].html("&nbsp")},_get_cursor_offset:function(){var c=
this._tabs_count(this._lines[this._pointer.y]);return(this._cols-this._settings.horizontalMoveOffset-1)*Math.floor((this._pointer.x+c)/(this._cols-1))-c},_tabs_count:function(c){return(c.match(/(\t)/g)||[]).length*3},_draw_cursor_line:function(){var c=this._pointer.y-this._offset,d=this._lines[this._pointer.y],a=this._tabs_count(d);if(this._pointer.x+a>=this._cols-1){var b=this._get_cursor_offset();this._draw_line(c,"$"+d.substring(b,b+this._cols));this._matrix[c][(this._pointer.x+a)%(this._cols-
1)+this._settings.horizontalMoveOffset+1].addClass("cursor")}else this._draw_line(c,d)},_view:function(c){if(this._lines){this._offset=c;var d=this._lines.slice(c,c+this._rows),a=this._pointer.y-c;if(d[a].length>this._cols&&this._pointer.x>this._cols){for(c=0;c<a;++c)this._draw_line(c,d[c]);this._draw_cursor_line();for(c=a+1;c<d.length;++c)this._draw_line(c,d[c])}else e.each(d,this._draw_line.bind(this));if(d.length<this._rows)for(c=d.length;c<this._rows;++c)this._draw_line(c,"")}return this},version:function(){return"0.1.1".match(/^\{\{V\}\}$/,
"0.1.1")?"":"0.1.1"},_set_file_name:function(c){var d="  jQuery Micro "+this.version();d+=l(" ",30-d.length)+e.micro.strings.file+": "+c;this._title.html(d.replace(/ /g,"&nbsp;"))},message:function(c){this._message.html(this._encode(c))},open:function(c,d){var a=this;e.get(c,function(b){a._set_file_name(c.replace(/.*\//,""));a._lines=b.split("\n");a._view(0);a._set_pointer(0,0);typeof d==="function"&&d()});return this},_calculate_letter_size:function(){var c=e('<div class="micro"><div><span>&nbsp;</span></div></div>').appendTo("body"),
d=c.find("span").width(),a=c.find("div").height();c.remove();return{width:d,height:a}}};e.micro={defaults:{enabled:true,tabStop:4,cursorPosition:false,save:null,exit:null,width:"100%",height:"400px",verticalMoveOffset:9,horizontalMoveOffset:6},strings:{file:"File",read:"Read %s Lines",chr:"line %d/%d (%d%%), col %d/%d (%d%%), char %d/%d (%d%%)",no_save:"You need to provide save function",get_help:"Get Help",exit:"Exit",write_out:"WriteOut",justify:"Justify",read_file:"Read File",where_is:"Where is",
prev_page:"Prev Page",next_page:"Next Page",cut_text:"Cut Text",uncut_text:"Uncut Text",cur_pos:"Cur Pos",to_spell:"To Speel"},init:k,fn:k.prototype};e.fn.micro=function(c){if(typeof c==="string"){var d=Array.prototype.slice.call(arguments);d.shift();if(c[0]!=="_"&&typeof e.micro.fn[c]==="function")if(this.length==1){var a=e(this).data("micro");return e.micro.fn[c].apply(a,d)}else return e.each(this,function(){var g=e(this).data("micro");e.micro.fn[c].apply(g,d)});else return this}else{var b=e.extend({},
e.micro.defaults,c);e.each(this,function(){e(this).data("micro",new e.micro.init(this,b))})}}})(jQuery);
