/**@license
 *  This file is part of Leash (Browser Shell)
 *  Copyright (c) 2013-2017 Jakub Jankiewicz <http://jcubic.pl/me>
 *
 *  Released under the MIT license
 *
 *  Date: Wed, 03 May 2017 18:04:56 +0000
 */
function Uploader(e){this.token=e.terminal.token();this.leash=e}Uploader.prototype.upload_tree=function e(r,n){var t=$.Deferred();var i=this;n=n||i.leash.cwd;function a(e,r){e=e.slice();(function n(){var i=e.shift();if(i){r(i).then(n).fail(function(){t.reject()})}else{t.resolve()}})()}function s(e){a(e,function(e){return i.upload_tree(e,n+"/"+r.name)})}function o(e){i.upload(e,n).then(function(){t.resolve()}).fail(function(){t.reject()})}if(typeof Directory!="undefined"&&r instanceof Directory){r.getFilesAndDirectories().then(function(e){s(e)})}else if(typeof File!="undefined"&&r instanceof File){o(r)}else if(r.isFile){r.file(o)}else if(r.isDirectory){var f=r.createReader();f.readEntries(function(e){s(e)})}return t.promise()};Uploader.prototype.upload=function r(e,n){var t=this;var i=$.Deferred();var a=n+"/"+e.name;if(e.size>t.leash.settings.upload_max_filesize){if(!(e.slice||e.webkitSlice)){t.leash.terminal.error("Exceeded filesize limit.");i.resolve();t.leash.animation.stop()}else{t.maybe_ask(a).then(function(){t.leash.animation.start(400);t.upload_by_chunks(e,n).then(function(){i.resolve();t.leash.animation.stop()}).fail(function(){i.reject();t.leash.animation.stop()})}).fail(function(){i.resolve();t.leash.animation.stop()})}}else{t.maybe_ask(a).then(function(){t.upload_file(e,n).then(function(){i.resolve();t.leash.animation.stop()}).fail(function(){i.reject();t.leash.animation.stop()})}).fail(function(){i.resolve();t.leash.animation.stop()})}return i.promise()};Uploader.prototype.upload_by_chunks=function n(e,r,t){var i=this;t=t||1048576;var a=$.Deferred();function s(r,n){if(e.slice){return e.slice(r,n)}else if(e.webkitSlice){return e.webkitSlice(r,n)}}var o=0;function f(n,o){if(n<e.size){var u=s(n,o);var c=new FormData;c.append("file",u,e.name);c.append("token",i.token);c.append("path",r);$.ajax({url:"lib/upload.php?append=1",type:"POST",success:function(e){if(e.error){i.leash.terminal.error(e.error);a.reject()}else{f(o,o+t)}},error:function(e,r,n){i.leash.terminal.error(e.statusText);a.reject()},data:c,cache:false,contentType:false,processData:false})}else{i.leash.terminal.echo('File "'+e.name+'" uploaded.');a.resolve()}}var u=r+"/"+e.name;this.leash.service.unlink(i.token,u)(function(e,r){if(e){i.leash.terminal.error(e.message);a.reject()}else{f(0,t)}});return a.promise()};Uploader.prototype.maybe_ask=function t(e){var r=this;var n=$.Deferred();if(r.answer){n.resolve()}else{r.leash.service.file_exists(e)(function(t,i){if(i){var a='File "'+e+'" exis'+"ts do you want to overwrite it (Y/N/A)? ";r.leash.terminal.history().disable();r.leash.terminal.push(function(e){if(e.match(/^(y|n|a)$/i)){r.leash.terminal.pop().history().enable();if(e.match(/^a$/i)){n.resolve();r.answer=true}else if(e.match(/^y$/i)){n.resolve()}else if(e.match(/^n$/i)){n.reject()}}},{prompt:a})}else{n.resolve()}})}return n.promise()};Uploader.prototype.upload_file=function i(e,r){var n=this;var t=$.Deferred();var i=new FormData;i.append("file",e);i.append("token",n.token);i.append("path",r);$.ajax({url:"lib/upload.php",type:"POST",success:function(r){n.leash.animation.stop();if(r.error){n.leash.terminal.error(r.error);t.reject()}else{n.leash.terminal.echo('File "'+e.name+'" '+"uploaded.");t.resolve()}},error:function(e,r,i){n.leash.terminal.error(e.statusText);t.reject()},data:i,cache:false,contentType:false,processData:false});return t.promise()};var leash=function(){var e=$.omap({blue:"#55f",green:"#4d4",grey:"#999"},function(e,r){return function(e,n){return"[["+(n||"")+";"+r+";]"+e+"]"}});var r=["Copyright (c) 2013-2017 Jakub Jankiewicz <http://jcubic.pl/me>","","Licensed under MIT license"].map(function(e){return e===""?e:"  "+e}).join("\n");function n(e,r,t){if(r>e.length){return n(t+e,r,t)}else{return e}}function t(e){var r=[];$.each(e,function(e,n){r.push(n);r.push(n.toLowerCase())});return r}function i(){var e=["ACCESSIBLE","ADD","ALL","ALTER","ANALYZE","AND","AS","ASC","ASENSITIVE","BEFORE","BETWEEN","BIGINT","BINARY","BLOB","BOTH","BY","CALL","CASCADE","CASE","CHANGE","CHAR","CHARACTER","CHECK","COLLATE","COLUMN","CONDITION","CONSTRAINT","CONTINUE","CONVERT","CREATE","CROSS","CURRENT_DATE","CURRENT_TIME","CURRENT_TIMESTAMP","CURRENT_USER","CURSOR","DATABASE","DATABASES","DAY_HOUR","DAY_MICROSECOND","DAY_MINUTE","DAY_SECOND","DEC","DECIMAL","DECLARE","DEFAULT","DELAYED","DELETE","DESC","DESCRIBE","DETERMINISTIC","DISTINCT","DISTINCTROW","DIV","DOUBLE","DROP","DUAL","EACH","ELSE","ELSEIF","ENCLOSED","ESCAPED","EXISTS","EXIT","EXPLAIN","FALSE","FETCH","FLOAT","FLOAT4","FLOAT8","FOR","FORCE","FOREIGN","FROM","FULLTEXT","GRANT","GROUP","HAVING","HIGH_PRIORITY","HOUR_MICROSECOND","HOUR_MINUTE","HOUR_SECOND","IF","IGNORE","IN","INDEX","INFILE","INNER","INOUT","INSENSITIVE","INSERT","INT","INT1","INT2","INT3","INT4","INT8","INTEGER","INTERVAL","INTO","IS","ITERATE","JOIN","KEY","KEYS","KILL","LEADING","LEAVE","LEFT","LIKE","LIMIT","LINEAR","LINES","LOAD","LOCALTIME","LOCALTIMESTAMP","LOCK","LONG","LONGBLOB","LONGTEXT","LOOP","LOW_PRIORITY","MASTER_SSL_VERIFY_SERVER_CERT","MATCH","MEDIUMBLOB","MEDIUMINT","MEDIUMTEXT","MIDDLEINT","MINUTE_MICROSECOND","MINUTE_SECOND","MOD","MODIFIES","NATURAL","NOT","NO_WRITE_TO_BINLOG","NULL","NUMERIC","ON","OPTIMIZE","OPTION","OPTIONALLY","OR","ORDER","OUT","OUTER","OUTFILE","PRECISION","PRIMARY","PROCEDURE","PURGE","RANGE","READ","READS","READ_WRITE","REAL","REFERENCES","REGEXP","RELEASE","RENAME","REPEAT","REPLACE","REQUIRE","RESTRICT","RETURN","REVOKE","RIGHT","RLIKE","SCHEMA","SCHEMAS","SECOND_MICROSECOND","SELECT","SENSITIVE","SEPARATOR","SET","SHOW","SMALLINT","SPATIAL","SPECIFIC","SQL","SQLEXCEPTION","SQLSTATE","SQLWARNING","SQL_BIG_RESULT","SQL_CALC_FOUND_ROWS","SQL_SMALL_RESULT","SSL","STARTING","STRAIGHT_JOIN","TABLE","TERMINATED","THEN","TINYBLOB","TINYINT","TINYTEXT","TO","TRAILING","TRIGGER","TRUE","UNDO","UNION","UNIQUE","UNLOCK","UNSIGNED","UPDATE","USAGE","USE","USING","UTC_DATE","UTC_TIME","UTC_TIMESTAMP","VALUES","VARBINARY","VARCHAR","VARCHARACTER","VARYING","WHEN","WHERE","WHILE","WITH","WRITE","XOR","YEAR_MONTH","ZEROFILL"];return t(e)}function a(){var e=["ABORT","ACTION","ADD","AFTER","ALL","ALTER","ANALYZE","AND","AS","ASC","ATTACH","AUTOINCREMENT","BEFORE","BEGIN","BETWEEN","BY","CASCADE","CASE","CAST","CHECK","COLLATE","COLUMN","COMMIT","CONFLICT","CONSTRAINT","CREATE","CROSS","CURRENT_DATE","CURRENT_TIME","CURRENT_TIMESTAMP","DATABASE","DEFAULT","DEFERRABLE","DEFERRED","DELETE","DESC","DETACH","DISTINCT","DROP","EACH","ELSE","END","ESCAPE","EXCEPT","EXCLUSIVE","EXISTS","EXPLAIN","FAIL","FOR","FOREIGN","FROM","FULL","GLOB","GROUP","HAVING","IF","IGNORE","IMMEDIATE","IN","INDEX","INDEXED","INITIALLY","INNER","INSERT","INSTEAD","INTERSECT","INTO","IS","ISNULL","JOIN","KEY","LEFT","LIKE","LIMIT","MATCH","NATURAL","NO","NOT","NOTNULL","NULL","OF","OFFSET","ON","OR","ORDER","OUTER","PLAN","PRAGMA","PRIMARY","QUERY","RAISE","RECURSIVE","REFERENCES","REGEXP","REINDEX","RELEASE","RENAME","REPLACE","RESTRICT","RIGHT","ROLLBACK","ROW","SAVEPOINT","SELECT","SET","TABLE","TEMP","TEMPORARY","THEN","TO","TRANSACTION","TRIGGER","UNION","UNIQUE","UPDATE","USING","VACUUM","VALUES","VIEW","VIRTUAL","WHEN","WHERE","WITH","WITHOUT"];return t(e)}function s(e,r,n){var t=new RegExp("^"+r.map($.terminal.escape_regex).join("|")+"$","i");return function(r){return r.split(/((?:\s|&nbsp;|\)|\()+)/).map(function(r){if(e.indexOf(r)!=-1){return"[[b;"+n+";]"+r+"]"}else if(r.match(t)){return"[[u;;]"+r+"]"}else{return r}}).join("")}}function o(e,r,n){function t(r,n){var t=$.terminal.escape_brackets("[AJAX] "+n+" server response\n"+r.responseText);e.error(t).resume()}function i(r){if(typeof r=="string"){e.error(r)}else{if(r.message){e.echo(r.message)}if(r.error.traceback){e.echo(r.error.traceback)}}}function a(n,a,s){if(a===undefined){a=[]}e.pause();$.jrpc(r,n,a,function(r){if(r.error){i(r.error)}else if(r.result){if(s===undefined||s){e.echo(r.result.replace(/\n$/,""))}}e.resume()},t)}e.pause();var s;$.jrpc(r,"start",[],function(t){if(t.error){i(t.error);e.resume()}else if(t.result){s=t.result;e.echo("[[b;#F8B612;]Warring: each time you execute a c"+"ommand, python will execute all your previous c"+"ommands, so watch out on commands that can be e"+"xecuted only once]");$.jrpc(r,"info",[],function(r){if(r.error){i(r.error)}else{e.echo(r.result)}n({evaluate:function(e){a("evaluate",[s,e])},destroy:function(){a("destroy",[s])}});e.resume()})}},t)}function f(r,n,t){var i=e.green(r+"&#64;"+n);var a=e.grey(r==="root"?"# ":"$ ");return i+e.grey(":")+e.blue(t)+a}return function(n){var t=new $.Deferred;var u;rpc({url:n||"",error:function(e){console.log(e);try{e=JSON.parse(e)}catch(r){}var n;if(e.error){e=e.error;n=e.message+" in "+e.file+"\n["+e.at+"] "+e.line}else{n=e.message||e}var t=$.terminal.active();if(t){t.error(n);t.leash().then(function(e){e.animation.stop();t.resume()})}else{alert(n)}if(u){u(null,true)}},debug:function(e,r){var n=r=="request"?"->":"<-"}})(function(n){var c;var l;var p=$.terminal.defaults.formatters;var m=[p];var h=[];var v=[];function d(e){var r=e;$.each(_.env,function(e,n){r=r.replace("$"+e,n)});return r}function g(e,r){if(e){E(e)}else{switch($.type(r)){case"array":if(r.length){var n=Object.keys(r[0]);r=[n].concat(r.map(function(e){if(e instanceof Array){return e.map(function(e){return $.terminal.escape_brackets(String(e))})}else{return Object.keys(e).map(function(r){return $.terminal.escape_brackets(String(e[r]))})}}));_.terminal.echo(T(r,true),{formatters:false})}break;case"number":_.terminal.echo("Query OK, "+r+" row affected")}}_.terminal.resume()}function E(e){if(e.error){_.terminal.error(e.error.message);_.terminal.error("in "+e.error.file+" at line "+e.error.at);_.terminal.error(e.error.line)}else{_.terminal.error(e.message)}}function T(e,r){if(!e.length){return""}for(var n=e.length-1;n>=0;n--){var t=e[n];var i=[];for(var a=0;a<t.length;a++){var s=t[a].toString().split("\n");t[a]=s.shift();i.push(s)}var o=Math.max.apply(Math,i.map(function(e){return e.length}));for(var f=o-1;f>=0;f--){e.splice(n+1,0,i.map(function(e){return e[f]||""}))}}var u=e[0].map(function(r,n){var t=e.map(function(e){if(e[n]!=undefined){var r=wcwidth(e[n]);if(e[n].match(/\t/g)){r+=e[n].match(/\t/g).length*3}return r}else{return 0}});return Math.max.apply(Math,t)});e=e.map(function(e){return"| "+e.map(function(e,r){var n=wcwidth(e);if(e.match(/\t/g)){n+=e.match(/\t/g).length*3}if(n<u[r]){e+=new Array(u[r]-n+1).join(" ")}return e}).join(" | ")+" |"});var c="+"+u.map(function(e){return new Array(e+3).join("-")}).join("+")+"+";if(r){return c+"\n"+e[0]+"\n"+c+"\n"+e.slice(1).join("\n")+"\n"+c}else{return c+"\n"+e.join("\n")+"\n"+c}}var R=[];var I=[];function A(e){return function(r,t,i){var a=e+" "+r.args[0];i.pause();n.shell(t,a,_.cwd)(function(e,r){if(e){E(e)}else{_.less($.terminal.escape_brackets(r.output))}i.resume()})}}var _={formatters:p,version:"0.14.0",date:"Wed, 03 May 2017 18:04:56 +0000",jargon:[],dirs:{},env:{},banner:function(){var e="";if(!_.version.match(/\{{2}VERSION\}{2}/)){e=" v. "+_.version}var r="";if(!_.date.match(/\{{2}DATE\}{2}/)){r="build at: "+_.date}var n=["   __   _______   ______ __","  / /  / __/ _ | / __/ // /"," / /__/ _// __ |_\\ \\/ _  /","/____/___/_/ |_/___/_//_/"+e];if(r){n.push(r)}n.push("");return n.join("\n")},animation:{animating:false,start:function(e){var r=["/","-","\\","|"],n=0;this.animating=true;this.prompt=_.terminal.get_prompt();var t=this;(function i(){_.terminal.set_prompt(r[n++]);if(n>r.length-1){n=0}t.timer=setTimeout(i,e)})()},stop:function(){if(this.animating){clearTimeout(this.timer);_.terminal.set_prompt(this.prompt);this.animating=false}}},service:n,init:function(e){e.on("click",".jargon",function(){var r="jargon "+$(this).data("text").replace(/\s/g," ");e.exec(r).then(function(){if(e.settings().historyState){e.save_state(r)}})}).on("click",".exec",function(){var r=$(this).data("text");e.exec(r).then(function(){if(e.settings().historyState){e.save_state(r)}})}).on("click",".wiki",function(){var r=$(this).data("text").replace(/\s/g," ");var n=$.terminal.split_command("wikipedia "+r);_.commands.wikipedia(n,e.token(),e)}).on("click",".rfc",function(){var r=$(this).data("text");var n=$.terminal.split_command("rfc "+r);_.commands.rfc(n,e.token(),e)}).on("click","a",function(r){if($(this).parents().is(".exception")){return}if(!r.ctrlKey){var n=e.token();var t=$(this).attr("href").trim();if(t.match(/^mailto:/)){return}_.less(function(e,r){_.service.html(n,t,e-1)(function(e,n){if(!e){r(n.trim().split("\n"))}})});return false}});if(!_.installed){_.install(e)}else{_.config(e)}},interpreter:function(e,r){if(!h.length){r.error("Not interpeter")}else{h[h.length-1](e,r)}},make_interpreter:function(e){return function(r,n){if(!_.installed){n.error("Invalid command, you need to refresh the p"+"age")}else{if($.terminal.unclosed_strings(r)){_.shell(r,e,n)}else{var t=$.terminal.parse_command(r);if(_.commands[t.name]){_.commands[t.name](t,e,n)}else if(r!==""){_.shell(r,e,n)}}}}},install:function(e){var r={};var t=[{name:"root_password",prompt:"root password: ",mask:true},{name:"server",text:"Type your server name"},{name:"username",text:"Your normal username"},{name:"home",text:"Home directory"},{name:"guest",text:"Allow guest sessions (Y)es/(N)o","boolean":true},{name:"sudo",text:"Execute sudo for user accounts (Y)es/(N)o","boolean":true},{name:"password",mask:true}];e.echo("[[;#C78100;]You are running Leash for the first"+" time. You need to configure it]\n");e.history().disable();(function i(n,a){var s=t[n];if(s){if(s.text){e.echo("[[b;#fff;]"+s.text+"]")}e.push(function(t){e.pop();if(s.mask){e.set_mask(false)}if(s.boolean){var o;if(t.match(/^Y(es)?/i)){o=true}else if(t.match(/^N(o)?/i)){o=false}if(typeof o!="undefined"){r[s.name]=o;i(n+1,a)}}else{r[s.name]=t;i(n+1,a)}},{prompt:s.prompt||s.name+": "});if(s.mask){e.set_mask(true)}}else{a()}})(0,function(){e.pause();var t=$.terminal.ansi_colors.bold;function i(a,s){if(a.length){var o=a[0];var f=a.slice(1);var u="Test Shell '"+o+"' ";n.test_shell(null,o)(function(n,a){if(a){u+="&#91;[[b;"+t.green+";]PASS]&#93;"}else{u+="&#91;[[b;"+t.red+";]FAIL]&#93;"}e.echo(u);if(a){e.echo("Using shell "+o);r.shell=o;s()}else{i(f,s)}})}else{e.error("Not valid shell found");e.error("You will not able to use Leash ful"+"ly");r.shell=null;s()}}e.echo("Detect Shell");n.list_shells(null)(function(t,a){i(a,function(){n.configure(r)(function(r){e.resume();if(r){e.error(r.message);_.install(e)}else{e.echo("Your instalation is complete no"+"w you can refresh the page and "+"login")}})})})})},config:function(e){var r=e.token();if(r){e.pause();n.valid_token(r)(function(t,i){if(!i){e.set_token(undefined);e.logout();e.resume()}else{_.token=r;_.env.TOKEN=r;h.push(_.make_interpreter(r));n.jargon_list()(function(e,r){if(!e){_.jargon=r}});n.get_settings(r)(function(t,i){if(t){E(t);e.resume();return}_.settings=l=i;_.cwd=l.home;if(i.show_messages!==false){var a=i.messages||[];e.echo(a.map(function(e){return"[[;#ff0;]"+e+"]"}).join("\n"))}n.dir(r,_.cwd)(function(r,n){_.dir=n;e.set_prompt(_.prompt);setTimeout(function(){e.resume()},100)});if(l.purgeOnUnload){$(window).unload(function(){e.purge()})}})}})}},refresh_dir:function(e){n.dir(_.token,_.cwd)(function(r,n){_.dir=n;if($.isFunction(e)){e()}})},shell:function(e,r,t){var i=/\|\s*less\s*$/;var a=$.Deferred();t.pause();if(e.match(i)){e=e.replace(i,"");n.shell(r,e,_.cwd)(function(e,r){if(e){E(e)}else{_.less(r.output)}t.resume();a.resolve()})}else{n.shell(r,e,_.cwd)(function(e,r){if(e){E(e);t.resume()}else{if(r.output){var n=/\n(\x1b\[m)?$/;var i=r.output.replace(n,"").replace(/\[\[/g,"&#91;&#91;").replace(/\]\]/g,"&#93;&#93;");t.echo(i)}_.cwd=r.cwd;_.refresh_dir(function(){t.resume();a.resolve()})}})}return a.promise()},wikipedia:function(e,r){function n(e){if(e.length==1){return e[0]}else if(e.length==2){return e.join(" and ")}else if(e.length>2){return e.slice(0,e.length-1).join(", ")+" and "+e[e.length-1]}}function t(e){return n(e.split("|").map(function(e){if(e.match(/^\s*.*\s*=/)){return""}else{return"[[bu;#fff;;wiki;]"+e+"]"}}).filter(function(e){return!!e}))}function i(e,r,n){var t=/\[\[([^\]]+)\]\]/;if(e.match()){return e.split(/(\[\[[^\]]+\]\])/).map(function(e){var n=e.match(t);if(n){return"[[bu;"+r+";;wiki]"+n[1]+"]"}else{return"[[;"+r+";]"+e+"]"}}).join("")}else{return"[[;"+r+";]"+(e||n)+"]"}}var a={main:function(e){return"Main Article: "+t(e)+"\n"},dunno:function(){return"?"},yes:function(e){return i(e,"#0f0","yes")},no:function(e){return i(e,"#f00","no")},partial:function(e){return i(e,"#ff0","partial")},"lang-ar":function(e){return"[[bu;#fff;;;Arabic_language]Arabic]: "+e},"(?:IPAc-en|IPA-en)":function(e){if(!e.match(/\|/)){return"English pronunciation: /"+e+"/"}var r={tS:"tʃ",dZ:"dʒ","J\\":"ɟ","p\\":"ɸ",B:"β",T:"θ",D:"ð",S:"ʃ",Z:"ʒ",C:"ç","j\\ (jj)":"ʝ",G:"ɣ","X\\":"ħ","?\\":"ʕ","h\\":"ɦ",F:"ɱ",J:"ɲ",N:"ŋ","4 (r)":"ɾ","r (rr)":"r","r\\":"ɹ",R:"ʀ",P:"ʋ",H:"ɥ",I:"ɪ",E:"ɛ","{":"æ",2:"ø",9:"œ",1:"i","@":"ə",6:"ɐ",3:"ɜ","}":"ʉ",8:"ɵ","&":"ɶ",M:"ɯ",7:"ɤ",V:"ʌ",A:"ɑ",U:"ʊ",O:"ɔ",Q:"ɒ",",":"ˌ","'":"ˈ",_:"ː"};var n={};var t="/"+e.split("|").map(function(e){if(!e.match(/^\s*-\s*$|^\s*en-us/)){var t=/^\s*(us|lang|pron|audio)\s*=?\s*(.*)/i;var i=e.match(t);if(i){n[i[1].toLowerCase().trim()]=i[2]||true}else{Object.keys(r).forEach(function(n){e=e.replace(n,r[n])});return e}}}).filter(Boolean).join("")+"/";t="[[bu;#fff;;wiki;Help:IPA for English]"+t+"]";if(n.pron){t="pronunciation: "+t}if(n.lang){t="English "+t}if(n.us){t="US "+t}return t},"quote box":function(e){var r=e.match(/\s*quote\s*=\s*("[^"]+"|[^|]+)/)[1];var n=/'''([^']+(?:'[^']+)*)'''/g;r=r.replace(n,function(e,r){return"][[bi;#fff;]"+r+"][[i;;]"}).replace(/''([^']+(?:'[^']+)*)''/g,"$1").replace(/\[\[([^\]]+)\]\]/g,function(e,r){r=r.split("|");if(r.length==1){return"][[bui;#fff;;wiki]"+r[0]+"][[i;;]"}else{return"][[bui;#fff;;wiki;"+r[0]+"]"+r[1]+"][[i;;]"}});var t=e.match(/\s*source\s*=\s*([^|]+)/)[1].replace(/^(—|-)/,"").trim();return"[[i;;]"+r+"]\n-- "+t},quote:function(e){e=e.replace(/^\s*\|/gm,"").split(/|(?![^\]]+\])/);var r={};e=e.map(function(e){var n=e.match(/\s*(\w+)\s*=\s*(.*)/);if(n){if(!isNaN(n[1])){return n[2]}else{r[n[1].toLowerCase()]=n[2];return""}}else{return e}}).join("");var n="";if(r.author){n=r.author}else if(e.match(/^ /m)){n=e.match(/^ (.*)/m)[1]}return"[[i;;]"+e.replace(/'''([^']+(?:'[^']+)*)'''/g,function(e,r){return"][[bi;#fff;]"+r+"][[i;;]"}).replace(/''([^']+(?:'[^']+)*)''/g,"$1").replace(/\[\[([^\]]+)\]\]/g,function(e,r){r=r.split("|");if(r.length==1){return"][[bui;#fff;;wiki]"+r+"][[i;;]"}else{return"][[bui;#fff;;wiki;"+r[0]+"]"+r[1]+"][[i;;]"}})+"]"+(n?"\n-- "+n:"")},"Cat main":function(e){return"The main article for this [[bu;#fff;;wiki"+";Help:category]Category] is [[bu;#fff;;wiki]"+e+"]\n"},"see also":function(e){return"See also "+t(e)+"\n"},tag:function(e){return s("<"+e+">...</"+e+">")},"(?:official website|official)":function(e){if(!e.match(/^http:/)){e="http://"+e}return"[[!;;;;"+e+"]Official Website]"},"IMDb name":function(e){if(r){var n=e.match(/id\s*=\s*([^|]+)/);var t;if(n){t=n[1]}else{t=e}var i="http://www.imdb.com/name/nm"+t;return"[[!;;;;"+i+"]"+r+"] "+"at the [[Internet Movie Database]]"}},"(?:tlx|tl)":function(e){e=e.split("|");var r="";if(e.length>1){r="|"+e.slice(1).join("|")}return s("{{")+"[[bu;#fff;;wiki;Template:"+e[0]+"]"+e[0]+"]"+r+s("}}")},"(?:as of|Asof)":function(e){e=e.split("|");var r=["January","February","March","April","May","June","July","August","September","October","November","December"];var n=[];var t={};for(var i=0;i<e.length;++i){var a=e[i].match(/(\w+)\s*=\s*(\w+)/);if(a){t[a[1].toLowerCase()]=a[2]}else{n.push(e[i])}}var s="As of ";if(t.since){s="Since "}if(t.lc=="y"){s=s.toLowerCase()}if(t.df&&t.df.toLowerCase()=="us"){return s+(n[1]?r[n[1]-1]+" ":"")+(n[2]?n[2]+", ":"")+n[0]}else{return s+(n[2]?n[2]+" ":"")+(n[1]?r[n[1]-1]+" ":"")+n[0]}}};function s(e){var r={"{":"&#123;","}":"&#125;","[":"&#91;","]":"&#93;","<":"&#60;",">":"&#62;","'":"&#39;"};Object.keys(r).forEach(function(n){e=e.replace(new RegExp("\\"+n,"g"),r[n])});return e}e=e.replace(/&nbsp;/g," ").replace(/^\s*;\s*([^:]+):\s*/gm,function(e,r){return"\n"+r+"\n\n"}).replace(/&/g,"&amp;").replace(/^\s*(=+)\s*([^=]+)\s*\1/gm,function(e,e,r){r=r.replace(/''([^']+)''/g,function(e,r){return"][[bi;#fff;]"+r+"][[b;#fff;]"});return"\n[[b;#fff;]"+r+"]\n"}).replace(/\[\.\.\.\]/g,"...").replace(/<code><pre>(.*?)<\/pre><\/code>/g,function(e,r){return s(r)}).replace(/\[\[(?=<nowki\s*\/>)/,function(e){return s(e)}).replace(/{{Cite([^}]+)}}(?![\s\n]*<\/ref>)/gi,function(e,r){var n=r.match(/title\s*=\s*([^|]+)/i);var t=r.match(/url\s*=\s*([^|]+)/i);if(n){if(t){return"[[!;;;;"+t[1].trim()+"]"+n[1].trim()+"]"}else{return n[1].trim()}}else{return""}}).replace(/<nowiki>([\s\S]*?)<\/nowiki>/g,function(e,r){return s(r)});var o=[/<ref[^>]*\/>/g,/<ref[^>]*>[\s\S]*?<\/ref>/g,/\[\[(file|image):[^[\]]*(?:\[\[[^[\]]*]][^[\]]*)*]]/gi,/<!--[\s\S]*?-->/g,/<gallery>[\s\S]*?<\/galery>/g];o.forEach(function(r){e=e.replace(r,"")});var f;for(var u in a){f=new RegExp("{{"+u+"\\|?(.*?)}}","gi");e=e.replace(f,function(e,r){return a[u](r)||""})}f=/{{[^{}]*(?:{(?!{)[^{}]*|}(?!})[^{}]*)*}}/g;do{var c=0;e=e.replace(f,function(e){c++;return""})}while(c);var l=/\[\[([!gbiuso]*);([^;]*)(;[^\]]*\])/i;function p(e,r){var n=/(\[\[[!gbiuso]*;[^;]*;[^\]]*\](?:[^\]]*\\\][^\]]*|[^\]]*|[^\[]*\[[^\]]*)\]?)/i;return function(t,i){return i.split(n).map(function(n){function t(n,t,i,a){return"[["+e+t+";"+(r||i)+a}if($.terminal.is_formatting(n)){return n.replace(l,t)}else{return"[["+e+";"+(r||"")+";]"+n+"]"}}).join("")}}e=e.replace(/\[\[([^\]]+)\]\]/g,function(e,r){if(e.match(l)){return e}if(e.match(/<nowiki[^>]*>/)){return $.terminal.escape_brackets(e)}r=r.replace(/^:(Category)/i,"$1").split("|");var n;if(r.length==1){n="[[bu;#fff;;wiki]"+r[0]+"]"}else{r[1]=r[1].replace(/''([^']+)''/gm,function(e,n){return"][[bui;#fff;;wiki;"+r[0]+"]"+n+"]"+"[[bu;#fff;;wiki;"+r[0]+"]"});n="[[bu;#fff;;wiki;"+r[0]+"]"+r[1]+"]"}return n}).replace(/'''([^']+(?:'[^']+)*)'''/g,p("b","#fff")).replace(/^(\n\s*)*/,"").replace(/([^[])\[(\s*(?:http|ftp)[^\[ ]+) ([^\]]+)\]/g,function(e,r,n,t){function i(e,r){return"][[!i;;;;"+n+"]"+r+"][[!;;;;"+n+"]"}t=t.replace(/'''([^']*(?:'[^']+)*)'''/g,"$1").replace(/''([^']*(?:'[^']+)*)''/g,i);return r+"[[!;;;;"+n+"]"+t+"]"}).replace(/<blockquote>([\s\S]*?)<\/blockquote>/g,p("i")).replace(/''([^']+(?:'[^']+)*)''/g,p("i")).replace(/{\|.*\n([\s\S]*?)\|}/g,function(e,r){var n=/\|\+(.*)\n/;var t;var i=r.match(n);if(i){var a=i[1].trim().replace(/\[\[([^;]+)(;[^\]]+\][^\]]+\])/g,function(e,r,n){return"][["+r+"i"+n+"[[i;;]"})}r=r.replace(/^.*\n/,"").replace(n,"").split(/\|\-.*\n/);if(r.length==1){t=false;r=r[0].replace(/[\n\s]*$/,"").split(/\n/).map(function(e){return[e]})}else{if(r[0].match(/^!|\n!/)){t=true}r=r.map(function(e){var r=/^[|!]|\n[|!]|\|\|/;if(e.match(r)){return e.split(r).map(function(e){return e.replace(/\n/g,"").trim()}).filter(function(e,r){return r!==0})}else{return[]}}).filter(function(e){return e.length})}var s="";if(a){s="\n[[i;;]"+a+"\n"}s+=T(r,t);return s}).replace(/#(REDIRECT)/i,"&#35;$1").replace(/(^\*.*(\n|$))+/gm,function(e){return"\n"+e}).replace(/(^#.*(\n|$))+/gm,function(e){e=e.split(/^#\s*/m).slice(1);return"\n"+e.map(function(r,n){return(e.length>9&&n<9?" ":"")+(n+1)+". "+r}).join("")+"\n"}).split(/(<pre[^>]*>[\s\S]*?<\/pre>)/).map(function(e,r){var n=e.match(/<pre[^>]*>([\s\S]*?)<\/pre>/);var t=/([^\n])\n(?![\n*|+]|\s*[0-9]|:|--|\[\[bu;#fff;;wiki\]Category)/gi;if(n){return n[1]}else{return e.replace(t,"$1 ").replace(/ +/g," ")}}).join("").replace(/<[^>]+>/gm,"").replace(/\n{3,}/g,"\n\n").replace(/\*(\S)/g,"* $1");return e},less:function(e,r){var n=_.terminal;var t=n.export_view();var i,a;var s=0;var o;var f;var u;var c=0;function l(){n.clear();if(f.length-s>a-1){u=":"}else{u="[[;;;inverted](END)]"}n.set_prompt(u);var e=f.slice(s,s+a-1);var r=/^(\[\[[!gbiuso]*;[^;]*;[^\]]*\])/i;e=e.map(function(e,n){if($.terminal.have_formatting(e)){var t,a=-1,s,o=0,f=null,u=false,l="";for(var p=0,m=e.length;p<m;++p){var h=e.substring(p).match(r);if(h){f=h[1];u=false}else if(f&&e[p]==="]"){if(u){f=null;u=false}else{u=true}}if(o===c&&a==-1){a=p;if(f&&u&&e[p]!="]"){l=f}}else if(p==m-1){if(c>o){t=""}else{t=l+e.substring(a,m);if(f&&u&&e[p]!="]"){t+="]"}}}else if(o===c+i-1){t=l+e.substring(a,p);if(f&&u){t+="]"}break}if((f&&u||!f)&&e[p]!="]"){if(e[p]==="&"){h=e.substring(p).match(/^(&[^;]+;)/);if(!h){throw new Error("Unclosed html entity in"+" line "+(n+1)+" at char "+(p+1))}p+=h[1].length-2;continue}else if(e[p]==="]"&&e[p-1]==="\\"){--o}else{++o}}}return t}else{return e.substring(c,c+i-1)}});if(e.length<a-1){while(a-1>e.length){e.push("~")}}n.echo(e.join("\n"))}function p(){n.pop().import_view(t);if($.isFunction(r)){r()}}function m(){i=n.cols();a=n.rows();if($.isFunction(e)){e(i,function(e){o=e;f=o.slice();l()})}else{o=e.split("\n");f=o.slice();l()}}m();var h=3;var v=false,d,g;function E(e,r){var t=$.terminal.escape_brackets(g),i=g.toLowerCase()==g?"i":"",a=new RegExp("^("+t+")",i),c=new RegExp(t,i),p=-1,m="",h=false,v=false;f=o.slice();if(r){p=s=0}for(var d=0;d<f.length;++d){var E=f[d];for(var T=0,R=E.length;T<R;++T){if(E[T]==="["&&E[T+1]==="["){h=true;v=false;e=T}else if(h&&E[T]==="]"){if(v){h=false;v=false}else{v=true;m=E.substring(e,T+1)}}else if(h&&v||!h){if(E.substring(T).match(a)){var I;if(h&&v){I="][[;;;inverted]$1]"+m}else{I="[[;;;inverted]$1]"}E=E.substring(0,T)+E.substring(T).replace(a,I);T+=I.length-2;if(d>s&&p===-1){p=s=d}}}}f[d]=E}l();n.set_command("");n.set_prompt(u);return p}n.push($.noop,{resize:m,mousewheel:function(e,r){if(r>0){s-=h;if(s<0){s=0}}else{s+=h;if(s-1>f.length-a){s=f.length-a+1}}l();return false},name:"less",keydown:function(e){var r=n.get_command();if(n.get_prompt()!=="/"){if(e.which==191){n.set_prompt("/")}else if(v&&$.inArray(e.which,[78,80])!=-1){if(e.which==78){if(d!=-1){d=E(d+1)}}else if(e.which==80){d=E(0,true)}}else if(e.which==81){p()}else if(e.which==39){c+=Math.round(i/2);l()}else if(e.which==37){c-=Math.round(i/2);if(c<0){c=0}l()}else{if(f.length>a){if(e.which===38){if(s>0){--s;l()}}else if(e.which===40){if(s<=f.length-a){++s;l()}}else if(e.which===34){s+=a;if(s>f.length-a+1){s=f.length-a+1}l()}else if(e.which===33){s-=a;if(s<0){s=0}l()}}}if(!e.ctrlKey&&!e.alKey){return false}}else{if(e.which===8&&r===""){n.set_prompt(u)}else if(e.which==13){if(r.length>0){v=true;s=0;g=r;d=E(0)}return false}}},prompt:u})},completion:function(e,r){var t=this.get_command();var i=this.login_name();var a;if(i=="guest"){a=_.settings.guest_commands}else{a=(_.dir.execs||[]).concat(l.executables)}function s(e){return(e.dirs||[]).map(function(e){return e+"/"})}function o(r){if(e.match(/^"/)){return r.map(function(e){return'"'+e})}else{return r.map(function(e){return e.replace(/([() ])/g,"\\$1")})}}var f=$.terminal.parse_command(t);var u=new RegExp("^\\s*"+$.terminal.escape_regex(e));var c=_.token;if(e.match(/^\$/)){n.shell(c,"env","/")(function(e,n){r(n.output.split("\n").map(function(e){return"$"+e.split(/=/)[0]}))})}else if(t.match(u)||t===""){var p=Object.keys(_.commands);r(p.concat(a))}else{var m=e.match(/(.*)\/([^\/]+)/);var h;if(f.name=="cd"){if(m){h=_.cwd+"/"+m[1];n.dir(c,h)(function(e,n){var t=(n.dirs||[]).map(function(e){return m[1]+"/"+e+"/"});r(t)})}else{r(s(_.dir))}}else if(f.name=="jargon"){r(_.jargon)}else{if(m){h=_.cwd+"/"+m[1];n.dir(c,h)(function(e,n){var t=s(n);var i=(n.files||[]).concat(t).map(function(e){return m[1]+"/"+e});r(i)})}else{var v=(_.dir.files||[]).concat(s(_.dir));r(v)}}}},onPush:function(e,r){var n=_.formatters.slice().concat(r.formatters||[]);$.terminal.defaults.formatters=n;m.push(n)},onPop:function(e,r){m.pop();if(m.length>0){var n=m[m.length-1];$.terminal.defaults.formatters=n}},execRead:function(e,r,n){var t=$.extend({history:true,context:null,token:false},n);var i=_.terminal;var a=i.history();if(!t.history){a.disable()}var s=[];if(t.token){s.push(i.token())}(function o(){var n=e.shift();if(n){if(typeof n==="object"){if(n.mask===true){i.set_mask(true)}prompt=n.prompt}else{prompt=n}i.read(prompt,function(e){s.push(e);i.set_mask(false);o()})}else{r.apply(t.context,s)}})()},commands:{github:function(r,n,t){var i=new optparse.OptionParser([["-u","--username USER","owner of the repo"],["-r","--repo REPO","repo to open"]]);i.banner="Usage: github [options]";var a,s,o="master";i.on("username",function(e,r){a=r});i.on("repo",function(e,r){s=r});i.parse(r.args);var f="https://api.github.com/repos";var u;var c;function l(e,r){var n=f+"/"+a+"/"+s+"/contents/"+e;$.ajax({url:n,type:"GET",success:function(e){r({dirs:e.filter(function(e){return e.type=="dir"}),files:e.filter(function(e){return e.type=="file"})})},error:function(e){t.error("wrong directory").resume()}})}function p(e,r){var n="https://raw.githubusercontent.com/"+a+"/"+s+"/master/"+e;$.ajax({url:n,type:"GET",success:r,error:function(e){t.error("file not found").resume()}})}function m(r){t.echo(r.dirs.map(function(r){return e.blue(r.name)}).concat(r.files.map(function(e){return e.name})).join("\n"))}function h(e,r){t.pause();p(v+e,function(e){r(e);t.resume()})}if(a&&s){var v="/";c=$.Deferred();l("",function(e){u=e;c.resolve()});t.push(function(e){var r=$.terminal.parse_command(e);if(r.name=="cd"){var n=r.args[0];if(r.args[0]==".."){n=v.replace(/[^\/]+\/$/,"")}else{n=(v=="/"?"":v)+r.args[0]}t.pause();c=$.Deferred();l(n,function(e){u=e;v=n;if(!v.match(/\/$/)){v+="/"}t.resume();c.resolve()})}else if(r.name=="less"){h(r.args[0],_.less)}else if(r.name=="cat"){h(r.args[0],t.echo)}else if(r.name=="ls"){if(r.args==0){m(u)}else{t.pause();l(r.args[0],function(e){m(e);t.resume()})}}else{t.echo("unknown command "+r.name)}},{prompt:function(r){var n=e.green(a+"&#64;"+s);var t=v;if(t!="/"){t="/"+t.replace(/\/$/,"")}r(n+e.grey(":")+e.blue(t)+"$ ")},name:"github",completion:function(e,r){var n=$.terminal.parse_command(this.get_command());var t=e.match(/(.*)\/([^\/]+)/);if(t){l(t[1],function(e){if(n.name=="cd"){r(e.dirs.map(function(e){return t[1]+"/"+e.name+"/"}))}else{r(e.files.map(function(e){return t[1]+"/"+e.name+"/"}).concat(e.dirs.map(function(e){return t[1]+"/"+e.name})))}})}else{c.then(function(){if(n.name=="cd"){r(u.dirs.map(function(e){return e.name+"/"}))}else{r(u.files.map(function(e){return e.name}).concat(u.dirs.map(function(e){return e.name+"/"})))}})}}})}else{t.echo(i)}},download:function(e,r,n){if(e.args.length==1){var t=_.cwd+"/"+e.args[0];var i=$("<iframe/>").hide().appendTo("body");i.load(function(){i.remove()});var a=$.param({filename:t,token:r});i.attr("src","lib/download.php?"+a)}else{n.echo("usage: download {FILENAME}")}},pushd:function(e,r,n){if(e.args.length==1){var t=_.cwd;if(I.length==0){I.push(t)}_.shell("cd "+e.args[0],r,n).then(function(){I.push(_.cwd);n.echo(I.slice().reverse().join(" "))})}else{n.echo("usage: pushd {DIRECTORY}")}},popd:function(e,r,n){if(I.length>1){I.pop();var t=I[I.length-1];_.shell("cd "+t,r,n).then(function(){n.echo(I.slice().reverse().join(" "))})}else{n.echo("popd: directory stack empty");I=[]}},update:function(e,r,n){n.pause();_.service.update(r)(function(e,r){if(e){E(e)}else if(r){n.echo("[[;#ff0;]Leash updated, you can now refresh "+"the browser]")}else{n.error("No new version available")}n.resume()})},rfc:function(e,r,n){var t=e.args.length?e.args[0]:null;n.pause();_.service.rfc(t)(function(e,r){if(e){E(e)}else{_.less(r.replace(/^[\s\n]+|[\s\n]+$/g,""))}n.resume()})},cat:function(e,r,t){if(e.command.match(/cat\s*$/)){t.push(function(e){t.echo(e)},{prompt:""})}else if(e.command.match(/cat\s*>+\s*\w+/)){var i="";var a=e.args[e.args.length-1];if(!a.match(/^\//)){a=_.cwd+"/"+a}t.push(function(e){i+=e+"\n"},{prompt:"",onExit:function(){if(e.args[0].match(/>>/)){n.append(r,a,i)(function(e,r){if(!r){t.error("Can't save file")}})}else{n.write(r,a,i)(function(e,r){if(!r){t.error("Can't save file")}})}},completion:[]})}else{_.shell(e.command,r,t)}},copyright:function(e,n,t){t.echo(r)},bzless:A("bzcat"),zless:A("zcat"),xzless:A("xzcat"),less:A("cat"),record:function(e,r,n){if(e.args[0]=="start"){n.history_state(true);

}else if(e.args[0]=="stop"){n.history_state(false)}else{n.echo("usage: record [stop|start]")}},timer:function(e,r,n){function t(){n.echo("usage: timer time [command]\ntime - number [smh]")}if(e.args.length>1){var i=e.args[0];var a=i.match(/^([0-9.]+)([smh])$/);if(a){var s=e.rest.trim().replace(/^[0-9.]+[smh]?/,"");i=parseFloat(a[1]);switch(a[2]){case"h":i*=24;case"m":i*=60;case"s":i*=1e3}n.pause();setTimeout(function(){_.interpreter(s,n)},i)}else{t()}}else{t()}},passwd:function(e,r,t){t.set_mask(true).history().disable();t.push(function(e){t.push(function(i){t.pause();n.valid_password(r,e)(function(e,a){if(a){n.change_password(r,i)(function(e){if(!e){t.echo("Password successfully changed")}else{t.error(e.message)}t.pop().pop().resume();t.set_mask(false).history().enable()})}else{t.error("Current password is not valid");t.pop().pop().resume();t.set_mask(false).history().enable()}})},{prompt:"new password: ",name:"passwd_2",keydown:function(e){if(e.which==68&&e.ctrlKey){t.pop().pop().echo("new password: ");t.set_mask(false).history().enable();return false}}})},{prompt:"current password: ",name:"passwd_1"})},rpc:function(e,r,t){var i=e.args[0]||"",a;if(i===""){a=function(e,r){r(Object.keys(n))}}else{var s=$.Deferred();$.jrpc(i,"system.describe",[],function(e){s.resolve(e.procs.map(function(e){return e.name}))},function(e,r,n){t.error("[AJAX]: "+r);t.resume();if(r=="Invalid JSON"){t.error(e.responseText)}s.reject()});a=function(e,r){s.then(r).fail(function(){r([])})}}t.push(function(e){var r=$.terminal.parse_command(d(e));t.pause();$.jrpc(i,r.name,r.args,function(e){if(e.error){if(e.error.error){var r=e.error.error;var n=r.file.replace(l.home,"");t.error(r.message+" in "+n+" at "+r.at);t.error(r.line)}else if(e.error.message){t.error(e.error.message)}}else{t.echo(JSON.stringify(e.result))}t.resume()},function(e,r,n){t.error("[AJAX]: "+r);t.resume();if(r=="Invalid JSON"){t.error(e.responseText)}})},{name:"rpc",prompt:"rpc> ",completion:a})},wikipedia:function(e,r,n){function t(r){var n=$.Deferred();$.ajax({url:a,data:{action:"query",prop:"revisions",rvprop:"content",format:"json",titles:e.rest},dataType:"jsonp",success:function(t){var i=t.query.pages;var a=Object.keys(i).map(function(e){var r=i[e];if(r.revisions){return r.revisions[0]["*"]}else if(typeof r.missing!="undefined"){return"Article Not Found"}}).join("\n");a=_.wikipedia(a,e.rest);if($.isFunction(r)){r(a)}n.resolve(a)}});return n.promise()}function i(){R.pop();if(!R.length){n.option("convertLinks",true)}}if(e.args.length===0){n.echo("Display contents of wikipedia articles\n"+"usage: wikipedia [{ARTICLE} |-s {TERM}]\n\n"+"-s {SEARCH TERM}")}else{n.pause();n.option("convertLinks",false);var a="https://en.wikipedia.org/w/api.php?";R.push(e.rest.replace(/^-s\s*/,""));if(e.rest.match(/^-s\s*/)){$.ajax({url:a,data:{action:"opensearch",format:"json",limit:100,search:e.rest.replace(/^-s\s*/,"")},dataType:"jsonp",success:function(e){if(e[1].length&&e[2].length){var r=e[1].map(function(r,n){return"[[bu;#fff;;wiki]"+r+"]\n"+e[2][n]}).join("\n\n");_.less(r,i);n.resume()}}})}else if(e.rest.match(/^Category:/)){$.ajax({url:a,data:{action:"query",list:"categorymembers",rvprop:"content",format:"json",cmlimit:500,cmtitle:e.rest},dataType:"jsonp",success:function(e){var r=e.query.categorymembers;var a=r.map(function(e){return"[[bu;#fff;;wiki]"+e.title+"]"}).join("\n");var s=/(\[\[bu;#fff;;wiki\]Category)/;t(function(e){a=e.replace(s,a+"\n\n$1");_.less(a,i);n.resume()})}})}else{t(function(e){_.less(function(r,n){var t=$.terminal.split_equal(e,r,true);n(t)},i);n.resume()})}}},jargon:function(e,r,t){if(!e.args.length){var i="This is the Jargon File, a comprehensiv"+"e compendium of hacker slang illuminating man"+"y aspects of hackish tradition, folklore, and"+" humor.\n\nusage: jargon [-s] [QUERY]\n\n-s s"+"earch jargon file";t.echo(i,{keepWords:true})}else if(e.args[0]=="-s"){t.pause();var a=e.rest.replace(/^-s/,"").trim();if(!a.match(/%/)){a="%"+a+"%"}_.service.jargon_search(a)(function(e,r){if(e){E(e)}else{t.echo(r.map(function(e){return"[[bu;#fff;;jargon]"+e.term+"]"}).join("\n"))}t.resume()})}else{t.pause();var s=e.args.join(" ").replace(/\s+/g," ");n.jargon(s)(function(e,r){if(e){E(e)}else{var n=$.map(r,function(e){var r="[[b;#fff;]"+e.term+"]";if(e.abbr){r+=" ("+e.abbr.join(", ")+")"}var n=new RegExp("((?:https?|ftps?)://\\S+)|"+"\\.(?!\\s|\\]\\s)\\)?","g");var t=e.def.replace(n,function(e,r){return r?r:e==".)"?".) ":". "});n=/\[(?![^;\]]*;[^;\]]*;[^\]]*\])[^\]]+\]/g;t=t.replace(n,function(e){return e.replace(/\]/g,"\\]")});return r+"\n"+t+"\n"}).join("\n");t.echo(n.replace(/\n$/,""),{keepWords:true})}t.resume()})}},man:function(e,r,t){if(e.args.length===0){t.echo("usage: man {COMMAND}")}else{t.pause();var i="MANWIDTH="+t.cols()+" "+e.command;n.shell(r,i,"/")(function(e,r){_.less($.terminal.overtyping(r.output));t.resume()})}},sqlite:function(e,r,n){n.pause();var t;if(!e.args.length){n.error("You need to provide the file").resume();return}if(e.args[0].match(/^\//)){t=e.args[0]}else{t=_.cwd+"/"+e.args[0]}function i(e){var i=a();n.push(function(e){if(e.match(/^\s*help\s*$/)){n.echo("show tables:\n	SELECT name FROM sqlite_m"+'aster WHERE type = "table"\ndescribe tabl'+"e:\n	PRAGMA table_info([TABLE NAME])")}else{n.pause();_.service.sqlite_query(r,t,e)(g)}},{name:"sqlite",prompt:"sqlite> ",completion:["help"].concat(i).concat(e),formatters:[s(i,e,"white")]})}var o='SELECT name FROM sqlite_master WHERE type = "table"';_.service.sqlite_query(r,t,o)(function(e,r){if(e){n.error(e.message)}else{i(r.map(function(e){return e["name"]}))}n.resume()})},mysql:function(e,r,t){var a,o,f,u;var c=new optparse.OptionParser([["-h","--host HOST","Host to connect to"],["-u","--username USER","Database user"],["-p","--password PASSWORD","Database password"]]);var l=[];for(var p=0;p<e.args.length;++p){var m=e.args[p].match(/^(-[a-z])(.*)/);if(m){l.push(m[1]);if(m[2]){l.push(m[2])}else if(m[1]=="-p"){l.push("")}}else{l.push(e.args[p])}}c.on(0,function(e){a=e});c.on("host",function(e,r){o=r});c.on("username",function(e,r){f=r});c.on("password",function(e,r){u=r});c.banner="Usage: mysql [Options] database";c.parse(l);if(!(a&&f)){t.echo(c);return}o=o||"localhost";function h(){t.pause();var e;function c(i){t.pause();n.mysql_query(r,e,i)(g)}function l(e){n.mysql_close(r,e)(function(){var r=h().filter(function(r){return r!=e});v(r)})}var p="[[b;#55f;]mysql]> ";function m(r,n){n=$.map(n,function(e){return Object.keys(e).map(function(r){return e[r]})});var a=i();t.push(c,{prompt:p,name:"mysql",onExit:function(){l(e)},completion:a.concat(n),formatters:[s(a,n,"white")]}).resume()}function h(){var e;try{e=JSON.parse($.Storage.get("leash_mysql"))}catch(r){e=[]}return e}function v(e){$.Storage.set("leash_mysql",JSON.stringify(e))}h().forEach(function(e){l(e)});n.mysql_connect(r,o,f,u,a)(function(i,a){if(i){E(i);t.resume()}else{e=a;var s=h();s.push(e);v(s);n.mysql_query(r,e,"show tables")(m)}})}if(!u){t.history().disable();t.push(function(e){u=e;t.pop().history().enable();h()},{prompt:"password: "}).set_mask("")}else{h()}},js:function(e,r,n){n.push(function(e,r){if(e!==undefined&&e!==""){try{var n=window.eval(e);if(n!==undefined){r.echo(new String(n))}}catch(t){r.error(new String(t))}}},{prompt:"[[;#D72424;]js]> ",name:"js"})},python:function(e,r,n){if(e.args.length){_.shell(e.command,r,n);return}var t="cgi-bin/python.py?token="+r;o(n,t,function(e){var r="";var t="Type help() for interactive help,"+" or help(object) for help about object.";n.push(function(i){if(i.match(/help/)){if(i.match(/^help *$/)){n.echo(t)}else{var a=/help\((.*)\)/;e.evaluate(i.replace(a,"print $1."+"__doc__"))}}else if(i.match(/:\s*$/)){r+=i+"\n";n.set_prompt("... ")}else if(r){if(i===""){n.set_prompt(">>> ");e.evaluate(r);r=""}else{r+=i+"\n"}}else{e.evaluate(i)}},{name:"python",prompt:">>> ",completion:false,onExit:function(){e.destroy()}})})},history:function(e,r,n){n.echo(n.history().data().join("\n"))},su:function(e,r,t){var i=new optparse.OptionParser([["-u","--user USER","User or root if not specified"]]);var a="root";i.on("user",function(e,r){a=r});i.parse(e.args);var s=function(){var e=t.level();return function r(){if(t.level()==e+1){t.logout()}}}();function o(e){var r,n;if(l&&l.server){r=l.server}else{r="unknown"}if(l&&_.cwd){var t=$.terminal.escape_regex(l.home);var i=new RegExp("^"+t);n=_.cwd.replace(i,"~")}else{n=_.cwd}a=a||$.terminal.active().login_name();e(f(a,r,n))}t.history().disable();function u(e){var r=arguments.length==2;t.pause();n.login(a,e)(function(e,n){t.history().enable();if(r){t.pop().set_mask(false)}if(e){t.error(e.message)}else if(n){v.push(_.cwd);h.push(_.make_interpreter(n));t.push(_.interpreter,{prompt:o,name:"su_"+a,onExit:function(){_.cwd=v.pop();h.pop();_.env.TOKEN=t.token(true);$(window).off("unload",s)}});t.set_token(n)}else{t.error("Wrong password")}t.resume()});$(window).unload(s)}if(a=="guest"){u("guest")}else{t.set_mask(true).push(u,{prompt:"password: "})}},adduser:function(e,r,t){var i={prompt:"password: ",mask:true};var a=["user: ",i,"home: "];function s(e,r,i,a){n.add_user(e,r,i,a)(function(e){if(e){t.error(e.message)}else{t.echo("user "+r+" added to leash")}})}_.execRead(a,s,{history:false,token:true})},purge:function(e,r,n){n.logout().purge()},help:function(e,r,n){function t(e){e=e.map(function(e){return"[[b;#fff;]"+e+"]"});return e.slice(0,-1).join(", ")+" and "+e[e.length-1]}n.echo("leash build in commands: "+t(Object.keys(_.commands)),{keepWords:true});n.echo("all other commands are exectute by the shell");n.echo("guest users can only exeucte: "+t(_.settings.guest_commands))}}};n.installed()(function(e,r){_.installed=r;if(r){var i;_.greetings=_.banner();_.prompt=function(e){var r,n;if(l&&l.server){r=l.server}else{r="unknown"}if(l&&_.cwd){var t=$.terminal.escape_regex(l.home);var a=new RegExp("^"+t);n=_.cwd.replace(a,"~")}else{n=_.cwd}i=i||$.terminal.active().login_name();e(f(i,r,n))};_.onImport=function(e){_.cwd=e.cwd;_.dir=e.dir;_.terminal.set_prompt(_.prompt)};_.onExport=function(){return{cwd:_.cwd,dir:_.dir}};_.set_login=function(e){i=e};_.login=function(e,r,t){u=t;this.pause();var a=this;n.login(e,r)(function(r,n){u=null;i=e;_.token=n;if(n&&typeof sysend!="undefined"){sysend.broadcast("leash.login",{user:e,token:n})}t(n);if(!n){a.resume()}})}}else{_.prompt="> ";_.login=false;_.greetings=null}t.resolve(_)})});return t.promise()}}();(function(e){e.fn.leash=function(r){if(!e.terminal||!e.fn.terminal){throw new Error("You need to include jQuery terminal to use leash")}if(this.data("leash")){return this.data("leash")}var n=e.Deferred();var t=this.size();var i=[];this.each(function(a){var s=e(this);var o=leash();s.data("leash",o);o.then(function(o){var f={onInit:o.init,completion:o.completion,linksNoReferrer:true,execHash:true,historyFilter:/^[^\s]/,onBeforeLogout:function(e){var r=e.token();if(r){o.service.logout(r)(function(){if(typeof sysend!="undefined"){sysend.broadcast("leash.logout")}})}},prompt:o.prompt,login:o.login,onExport:o.onExport,onImport:o.onImport,onPop:o.onPop,onPush:o.onPush,extra:{formatters:o.formatters},name:"leash",outputLimit:500,greetings:o.greetings,keypress:function(e){if(o.animation.animating){if(e.which==68&&e.ctrlKey){o.animation.stop()}return false}}};var u=e.extend(f,r||{});var c=s.terminal(o.interpreter,u);o.terminal=c;c.on("drop",function(e){e.preventDefault();var r=e.originalEvent;if(!c.token()){return}var n=new Uploader(o);var t;if(r.dataTransfer.items){t=[].slice.call(r.dataTransfer.items)}var i=r.dataTransfer.files||r.target.files;if(i){i=[].slice.call(i)}function a(){o.refresh_dir()}if(t&&t.length){if(t[0].webkitGetAsEntry){var s=[];t.forEach(function(e){var r=e.webkitGetAsEntry();if(r)s.push(r)});(function f(){var e=s.shift();if(e){n.upload_tree(e,o.cwd).then(f)}else{a()}})()}}else if(i&&i.length){(function u(){var e=i.shift();if(e){n.upload(e,o.cwd).then(u)}else{a()}})()}else if(r.dataTransfer.getFilesAndDirectories){r.dataTransfer.getFilesAndDirectories().then(function(e){(function r(){var t=e.shift();if(t){n.upload_tree(t,o.cwd).then(r)}else{a()}})()})}}).on("dragover",function(e){e.preventDefault()}).on("dragenter",function(e){e.preventDefault()});if(typeof sysend!="undefined"){sysend.on("leash.logout",function(){o.prompt(function(e){c.echo(e)});c.logout()});sysend.on("leash.login",function(e){c.autologin(e.user,e.token);o.set_login(e.user)})}i.push(o);if(t-1==a){n.resolve.apply(n,i)}})});return n.promise()}})(jQuery);